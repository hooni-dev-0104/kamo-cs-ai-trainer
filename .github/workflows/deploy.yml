name: Trigger Vercel Deployment

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  build-check:
    name: Build Verification
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run build
        run: npm run build
        env:
          # ë¹Œë“œ ê²€ì¦ìš© (ì‹¤ì œ ê°’ì€ í•„ìš” ì—†ì§€ë§Œ íƒ€ìž… ì²´í¬ë¥¼ ìœ„í•´)
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL || 'https://placeholder.supabase.co' }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY || 'placeholder' }}
          VITE_GOOGLE_CLOUD_API_KEY: ${{ secrets.VITE_GOOGLE_CLOUD_API_KEY || 'placeholder' }}
          VITE_GOOGLE_CLOUD_PROJECT_ID: ${{ secrets.VITE_GOOGLE_CLOUD_PROJECT_ID || 'placeholder' }}

  trigger-vercel-deployment:
    name: Trigger Vercel Build
    needs: build-check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      deployments: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Vercel Project ID
        id: vercel-project
        run: |
          # Team IDê°€ ì„¤ì •ë˜ì–´ ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ Personal ê³„ì •
          if [ -n "${{ secrets.VERCEL_TEAM_ID }}" ]; then
            API_URL="https://api.vercel.com/v9/projects?teamId=${{ secrets.VERCEL_TEAM_ID }}"
          else
            API_URL="https://api.vercel.com/v9/projects"
          fi
          
          PROJECT_ID=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            "$API_URL" | \
            jq -r '.projects[] | select(.name=="kamo-cs-trainer") | .id')
          
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "Error: Project 'kamo-cs-trainer' not found."
            echo "Available projects:"
            curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" "$API_URL" | jq -r '.projects[] | .name'
            exit 1
          fi
          
          echo "project_id=$PROJECT_ID" >> $GITHUB_OUTPUT
          echo "Found Vercel Project ID: $PROJECT_ID"

      - name: Get GitHub Repository ID
        id: github-repo
        run: |
          REPO_ID=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}" | \
            jq -r '.id')
          
          if [ -z "$REPO_ID" ] || [ "$REPO_ID" = "null" ]; then
            echo "Error: Failed to get GitHub repository ID"
            exit 1
          fi
          
          echo "repo_id=$REPO_ID" >> $GITHUB_OUTPUT
          echo "GitHub Repository ID: $REPO_ID"

      - name: Trigger Vercel Deployment
        id: deploy
        run: |
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.vercel.com/v13/deployments" \
            -d "{
              \"name\": \"kamo-cs-trainer\",
              \"project\": \"${{ steps.vercel-project.outputs.project_id }}\",
              \"target\": \"production\",
              \"gitSource\": {
                \"type\": \"github\",
                \"repoId\": ${{ steps.github-repo.outputs.repo_id }},
                \"ref\": \"${{ github.ref_name }}\",
                \"sha\": \"${{ github.sha }}\"
              }
            }")
          
          DEPLOYMENT_URL=$(echo $RESPONSE | jq -r '.url')
          DEPLOYMENT_ID=$(echo $RESPONSE | jq -r '.uid')
          
          if [ "$DEPLOYMENT_URL" = "null" ] || [ -z "$DEPLOYMENT_URL" ]; then
            echo "Error: Failed to trigger deployment"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "âœ… Vercel deployment triggered!"
          echo "Deployment URL: $DEPLOYMENT_URL"
          echo "Deployment ID: $DEPLOYMENT_ID"

      - name: Wait for Deployment
        run: |
          DEPLOYMENT_ID="${{ steps.deploy.outputs.deployment_id }}"
          MAX_WAIT=60 # 5ë¶„
          ELAPSED=0
          
          echo "Waiting for deployment to complete..."
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(curl -s -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" \
              "https://api.vercel.com/v13/deployments/$DEPLOYMENT_ID" | \
              jq -r '.readyState')
            
            if [ "$STATUS" = "READY" ]; then
              echo "âœ… Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "ERROR" ] || [ "$STATUS" = "CANCELED" ]; then
              echo "âŒ Deployment failed with status: $STATUS"
              exit 1
            fi
            
            echo "Deployment status: $STATUS (waiting...)"
            sleep 10
            ELAPSED=$((ELAPSED + 10))
          done
          
          echo "â±ï¸ Deployment is taking longer than expected, but it's still running."
          echo "Check status at: ${{ steps.deploy.outputs.deployment_url }}"

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Vercel Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: âœ… Triggered" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL**: ${{ steps.deploy.outputs.deployment_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment ID**: ${{ steps.deploy.outputs.deployment_id }}" >> $GITHUB_STEP_SUMMARY

